<!doctype html>
<html lang="zh-tw">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Google Identity Services æ¸¬è©¦</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 600px;
        margin: 50px auto;
        padding: 20px;
        line-height: 1.6;
      }
      .test-section {
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #f9f9f9;
      }
      button {
        background-color: #4285f4;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        margin: 10px 5px;
      }
      button:hover {
        background-color: #357ae8;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .log {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 5px;
        padding: 15px;
        margin: 20px 0;
        font-family: monospace;
        font-size: 12px;
        max-height: 400px;
        overflow-y: auto;
      }
      .user-info {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
      }
      .error {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
        color: #721c24;
      }
    </style>
  </head>
  <body>
    <h1>Google Identity Services æ¸¬è©¦</h1>

    <div class="test-section">
      <h3>ç’°å¢ƒæª¢æŸ¥</h3>
      <p><strong>Client ID:</strong> <span id="clientId">è¼‰å…¥ä¸­...</span></p>
      <p><strong>ç•¶å‰ç¶²åŸŸ:</strong> <span id="domain"></span></p>
      <p><strong>Google API ç‹€æ…‹:</strong> <span id="apiStatus">æª¢æŸ¥ä¸­...</span></p>
      <button onclick="checkEnvironment()">é‡æ–°æª¢æŸ¥</button>
    </div>

    <div class="test-section">
      <h3>ç™»å…¥æ¸¬è©¦</h3>
      <button id="signInBtn" onclick="testSignIn()">æ¸¬è©¦ç™»å…¥</button>
      <button id="signOutBtn" onclick="testSignOut()" disabled>ç™»å‡º</button>
      <div id="userInfo"></div>
      <div id="errorInfo"></div>
    </div>

    <div id="log" class="log"></div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
      let tokenClient = null
      let currentUser = null

      // å¾ç’°å¢ƒè®Šæ•¸ç²å– Client ID (é€™è£¡éœ€è¦æ‰‹å‹•è¨­ç½®)
      const CLIENT_ID = '1075042227642-r406tu3a1noo14n69in7383657i9od6u.apps.googleusercontent.com'

      function addLog(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString()
        const logEntry = document.createElement('div')
        logEntry.innerHTML = `[${timestamp}] ${message}`
        if (type === 'error') logEntry.style.color = 'red'
        if (type === 'success') logEntry.style.color = 'green'
        if (type === 'warning') logEntry.style.color = 'orange'
        document.getElementById('log').appendChild(logEntry)
        document.getElementById('log').scrollTop = document.getElementById('log').scrollHeight
      }

      function checkEnvironment() {
        addLog('ğŸ” æª¢æŸ¥ç’°å¢ƒ...')

        document.getElementById('clientId').textContent = CLIENT_ID.substring(0, 30) + '...'
        document.getElementById('domain').textContent = window.location.origin

        if (typeof window.google !== 'undefined' && window.google.accounts) {
          document.getElementById('apiStatus').textContent = 'âœ… å·²è¼‰å…¥'
          document.getElementById('apiStatus').style.color = 'green'
          addLog('âœ… Google Identity Services å·²è¼‰å…¥', 'success')
          initTokenClient()
        } else {
          document.getElementById('apiStatus').textContent = 'âŒ æœªè¼‰å…¥'
          document.getElementById('apiStatus').style.color = 'red'
          addLog('âŒ Google Identity Services æœªè¼‰å…¥', 'error')
          // ç­‰å¾…è¼‰å…¥
          setTimeout(checkEnvironment, 1000)
        }
      }

      function initTokenClient() {
        try {
          addLog('ğŸ”§ åˆå§‹åŒ– Token Client...')

          tokenClient = window.google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: 'profile email',
            callback: handleAuthResponse,
            error_callback: handleAuthError,
          })

          addLog('âœ… Token Client åˆå§‹åŒ–æˆåŠŸ', 'success')
          document.getElementById('signInBtn').disabled = false
        } catch (error) {
          addLog(`âŒ Token Client åˆå§‹åŒ–å¤±æ•—: ${error.message}`, 'error')
        }
      }

      function handleAuthResponse(response) {
        addLog('ğŸ‰ èªè­‰æˆåŠŸï¼Œç²å–ç”¨æˆ¶è³‡è¨Š...', 'success')
        console.log('Auth response:', response)

        if (response.access_token) {
          fetchUserInfo(response.access_token)
        } else {
          addLog('âŒ æœªæ”¶åˆ° access token', 'error')
        }
      }

      function handleAuthError(error) {
        addLog(`âŒ èªè­‰éŒ¯èª¤: ${JSON.stringify(error)}`, 'error')
        document.getElementById('errorInfo').innerHTML = `
                <div class="error">
                    <strong>èªè­‰å¤±æ•—:</strong> ${error.type || 'æœªçŸ¥éŒ¯èª¤'}
                </div>
            `
      }

      async function fetchUserInfo(accessToken) {
        try {
          addLog('ğŸ“¡ æ­£åœ¨ç²å–ç”¨æˆ¶è³‡è¨Š...')

          const response = await fetch(
            `https://www.googleapis.com/oauth2/v2/userinfo?access_token=${accessToken}`,
          )

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`)
          }

          const userInfo = await response.json()
          currentUser = userInfo

          addLog('âœ… ç”¨æˆ¶è³‡è¨Šç²å–æˆåŠŸ', 'success')
          console.log('User info:', userInfo)

          displayUserInfo(userInfo)

          document.getElementById('signInBtn').disabled = true
          document.getElementById('signOutBtn').disabled = false
          document.getElementById('errorInfo').innerHTML = ''
        } catch (error) {
          addLog(`âŒ ç²å–ç”¨æˆ¶è³‡è¨Šå¤±æ•—: ${error.message}`, 'error')
          document.getElementById('errorInfo').innerHTML = `
                    <div class="error">
                        <strong>ç²å–ç”¨æˆ¶è³‡è¨Šå¤±æ•—:</strong> ${error.message}
                    </div>
                `
        }
      }

      function displayUserInfo(userInfo) {
        document.getElementById('userInfo').innerHTML = `
                <div class="user-info">
                    <h4>ç™»å…¥æˆåŠŸ!</h4>
                    <img src="${userInfo.picture}" alt="é ­åƒ" style="width: 50px; height: 50px; border-radius: 50%; margin-right: 10px;">
                    <strong>å§“å:</strong> ${userInfo.name}<br>
                    <strong>é›»å­éƒµä»¶:</strong> ${userInfo.email}<br>
                    <strong>ID:</strong> ${userInfo.id}
                </div>
            `
      }

      function testSignIn() {
        if (!tokenClient) {
          addLog('âŒ Token Client æœªåˆå§‹åŒ–', 'error')
          return
        }

        addLog('ğŸ” é–‹å§‹ç™»å…¥æµç¨‹...')
        document.getElementById('errorInfo').innerHTML = ''

        tokenClient.requestAccessToken({
          prompt: 'select_account',
        })
      }

      function testSignOut() {
        addLog('ğŸšª ç™»å‡º...')

        currentUser = null
        document.getElementById('userInfo').innerHTML = ''
        document.getElementById('signInBtn').disabled = false
        document.getElementById('signOutBtn').disabled = true

        addLog('âœ… ç™»å‡ºæˆåŠŸ', 'success')
      }

      // é é¢è¼‰å…¥å®Œæˆå¾Œæª¢æŸ¥ç’°å¢ƒ
      window.addEventListener('load', () => {
        addLog('ğŸš€ é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹æª¢æŸ¥ç’°å¢ƒ...')
        setTimeout(checkEnvironment, 500)
      })
    </script>
  </body>
</html>
